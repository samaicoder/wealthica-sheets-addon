<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Wealthica Excel Exporter</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    button { padding: 12px 24px; margin: 10px 5px; font-size: 16px; cursor: pointer; background: #5469d4; color: white; border: none; border-radius: 5px; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #log { background: #f5f5f5; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; margin-top: 20px; border: 1px solid #ddd; font-size: 13px; }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ðŸ“Š Wealthica Excel Exporter</h2>
  <div id="status">Loading...</div>
  <div>
    <button id="btn-transactions" disabled>Download Transactions</button>
    <button id="btn-positions" disabled>Download Positions</button>
    <button id="btn-all" disabled>Download All</button>
  </div>
  <div id="log"></div>

  <!-- Excel library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Wealthica addon - MUST load from their CDN -->
  <script src="https://wealthica.github.io/wealthica.js/addon/addon.js"></script>
  
  <!-- Our code -->
  <script>
    (function() {
      var log = function(msg, type) {
        var el = document.getElementById('log');
        var div = document.createElement('div');
        div.className = type || '';
        div.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
        el.insertBefore(div, el.firstChild);
      };
      
      var status = function(msg) {
        document.getElementById('status').textContent = msg;
      };
      
      // Check if libraries loaded
      log('Checking libraries...');
      if (typeof XLSX === 'undefined') {
        log('ERROR: XLSX library not loaded', 'error');
        status('ERROR: Excel library failed to load');
        return;
      }
      log('XLSX library OK', 'success');
      
      if (typeof Addon === 'undefined') {
        log('ERROR: Addon not found', 'error');
        status('ERROR: Wealthica library failed to load');
        return;
      }
      log('Addon class found', 'success');
      
      // Initialize addon
      var addon = new Addon();
      log('Addon instance created', 'success');
      
      var options = {};
      
      addon.on('init', function(opts) {
        options = opts;
        log('âœ“ CONNECTED TO WEALTHICA!', 'success');
        status('âœ“ Ready to export');
        document.getElementById('btn-transactions').disabled = false;
        document.getElementById('btn-positions').disabled = false;
        document.getElementById('btn-all').disabled = false;
      });
      
      addon.on('update', function(opts) {
        options = opts;
        log('Filters updated');
      });
      
      // Export transactions
      document.getElementById('btn-transactions').onclick = function() {
        log('Fetching transactions...');
        status('Fetching...');
        
        addon.api.getTransactions({
          from: options.fromDate || '2024-01-01',
          to: options.toDate || new Date().toISOString().split('T')[0]
        }).then(function(response) {
          var txs = response.data || response;
          log('Got ' + txs.length + ' transactions', 'success');
          
          var data = txs.map(function(tx) {
            return {
              Date: tx.date || '',
              Type: tx.type || '',
              Description: tx.description || '',
              Symbol: tx.symbol || '',
              Quantity: tx.quantity || '',
              Price: tx.price || '',
              Amount: tx.amount || '',
              Currency: tx.currency || ''
            };
          });
          
          var ws = XLSX.utils.json_to_sheet(data);
          var wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
          XLSX.writeFile(wb, 'Wealthica_Transactions.xlsx');
          
          log('âœ“ Downloaded Excel file!', 'success');
          status('âœ“ Export complete');
        }).catch(function(err) {
          log('ERROR: ' + err.message, 'error');
          status('Export failed');
        });
      };
      
      // Export positions
      document.getElementById('btn-positions').onclick = function() {
        log('Fetching positions...');
        status('Fetching...');
        
        addon.api.getPositions({}).then(function(response) {
          var pos = response.data || response;
          log('Got ' + pos.length + ' positions', 'success');
          
          var data = pos.map(function(p) {
            return {
              Symbol: (p.security && p.security.symbol) || '',
              Name: (p.security && p.security.name) || '',
              Quantity: p.quantity || '',
              'Market Value': p.market_value || '',
              Currency: (p.security && p.security.currency) || ''
            };
          });
          
          var ws = XLSX.utils.json_to_sheet(data);
          var wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Positions');
          XLSX.writeFile(wb, 'Wealthica_Positions.xlsx');
          
          log('âœ“ Downloaded Excel file!', 'success');
          status('âœ“ Export complete');
        }).catch(function(err) {
          log('ERROR: ' + err.message, 'error');
          status('Export failed');
        });
      };
      
      // Export all
      document.getElementById('btn-all').onclick = function() {
        log('Fetching all data...');
        status('Fetching...');
        
        Promise.all([
          addon.api.getTransactions({ from: '2024-01-01' }),
          addon.api.getPositions({})
        ]).then(function(results) {
          var txs = results[0].data || results[0];
          var pos = results[1].data || results[1];
          
          log('Got ' + txs.length + ' transactions, ' + pos.length + ' positions', 'success');
          
          var txData = txs.map(function(tx) {
            return { Date: tx.date || '', Type: tx.type || '', Symbol: tx.symbol || '', Amount: tx.amount || '' };
          });
          
          var posData = pos.map(function(p) {
            return { Symbol: (p.security && p.security.symbol) || '', Quantity: p.quantity || '', Value: p.market_value || '' };
          });
          
          var wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(txData), 'Transactions');
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(posData), 'Positions');
          XLSX.writeFile(wb, 'Wealthica_Complete.xlsx');
          
          log('âœ“ Downloaded Excel file!', 'success');
          status('âœ“ Export complete');
        }).catch(function(err) {
          log('ERROR: ' + err.message, 'error');
          status('Export failed');
        });
      };
      
      log('Waiting for Wealthica connection...');
      status('Waiting for connection...');
    })();
  </script>
</body>
</html>
