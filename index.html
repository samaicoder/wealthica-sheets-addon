<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Wealthica Excel Exporter</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    button { padding: 12px 24px; margin: 10px 5px; font-size: 16px; cursor: pointer; background: #5469d4; color: white; border: none; border-radius: 5px; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #log { background: #f5f5f5; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; margin-top: 20px; border: 1px solid #ddd; font-size: 13px; }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ðŸ“Š Wealthica Excel Exporter</h2>
  <div id="status">Loading libraries...</div>
  <div>
    <button id="btn-transactions" disabled>Download Transactions</button>
    <button id="btn-positions" disabled>Download Positions</button>
    <button id="btn-all" disabled>Download All</button>
  </div>
  <div id="log"></div>

  <!-- Excel library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Wealthica addon library -->
  <script src="https://wealthica.github.io/wealthica.js/addon/addon.js"></script>
  
  <!-- Our code - waits for everything to load -->
  <script>
    (function() {
      var attempts = 0;
      var maxAttempts = 50; // 5 seconds max
      
      var log = function(msg, type) {
        var el = document.getElementById('log');
        var div = document.createElement('div');
        div.className = type || '';
        div.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
        el.insertBefore(div, el.firstChild);
      };
      
      var status = function(msg) {
        document.getElementById('status').textContent = msg;
      };
      
      // Wait for libraries to load
      function checkLibraries() {
        attempts++;
        
        if (typeof XLSX === 'undefined') {
          if (attempts < maxAttempts) {
            setTimeout(checkLibraries, 100);
            return;
          }
          log('ERROR: XLSX library failed to load', 'error');
          status('ERROR: Excel library failed');
          return;
        }
        
        if (typeof Addon === 'undefined') {
          if (attempts < maxAttempts) {
            status('Loading Wealthica library... (' + attempts + ')');
            setTimeout(checkLibraries, 100);
            return;
          }
          log('ERROR: Addon library failed to load after ' + attempts + ' attempts', 'error');
          status('ERROR: Wealthica library failed to load');
          return;
        }
        
        // Both libraries loaded!
        log('âœ“ All libraries loaded (attempts: ' + attempts + ')', 'success');
        initializeAddon();
      }
      
      function initializeAddon() {
        log('Initializing Wealthica addon...');
        
        var addon = new Addon();
        var options = {};
        
        addon.on('init', function(opts) {
          options = opts;
          log('âœ“ CONNECTED TO WEALTHICA!', 'success');
          status('âœ“ Ready to export');
          document.getElementById('btn-transactions').disabled = false;
          document.getElementById('btn-positions').disabled = false;
          document.getElementById('btn-all').disabled = false;
        });
        
        addon.on('update', function(opts) {
          options = opts;
          log('Filters updated');
        });
        
        // Export transactions
        document.getElementById('btn-transactions').onclick = function() {
          this.disabled = true;
          log('Fetching transactions...');
          status('Fetching transactions...');
          
          addon.api.getTransactions({
            from: options.fromDate || '2024-01-01',
            to: options.toDate || new Date().toISOString().split('T')[0]
          }).then(function(response) {
            var txs = response.data || response;
            log('âœ“ Fetched ' + txs.length + ' transactions', 'success');
            
            if (txs.length === 0) {
              log('No transactions found', 'error');
              status('No transactions to export');
              document.getElementById('btn-transactions').disabled = false;
              return;
            }
            
            var data = txs.map(function(tx) {
              return {
                Date: tx.date || (tx.origin_date ? new Date(tx.origin_date).toISOString().split('T')[0] : ''),
                Type: tx.type || '',
                Description: tx.description || '',
                Symbol: tx.symbol || tx.ticker || '',
                Quantity: tx.quantity || '',
                Price: tx.price || '',
                Amount: tx.currency_amount || tx.amount || '',
                Currency: tx.currency || '',
                Institution: tx.institution || ''
              };
            });
            
            var ws = XLSX.utils.json_to_sheet(data);
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
            XLSX.writeFile(wb, 'Wealthica_Transactions.xlsx');
            
            log('âœ“ Downloaded Wealthica_Transactions.xlsx', 'success');
            status('âœ“ Export complete!');
            document.getElementById('btn-transactions').disabled = false;
          }).catch(function(err) {
            log('ERROR: ' + err.message, 'error');
            status('Export failed');
            document.getElementById('btn-transactions').disabled = false;
          });
        };
        
        // Export positions
        document.getElementById('btn-positions').onclick = function() {
          this.disabled = true;
          log('Fetching positions...');
          status('Fetching positions...');
          
          addon.api.getPositions({
            groups: options.groupsFilter,
            institutions: options.institutionsFilter
          }).then(function(response) {
            var pos = response.data || response;
            log('âœ“ Fetched ' + pos.length + ' positions', 'success');
            
            if (pos.length === 0) {
              log('No positions found', 'error');
              status('No positions to export');
              document.getElementById('btn-positions').disabled = false;
              return;
            }
            
            var data = pos.map(function(p) {
              return {
                Symbol: (p.security && p.security.symbol) || p.symbol || '',
                Name: (p.security && p.security.name) || p.name || '',
                Type: (p.security && p.security.type) || p.type || '',
                Quantity: p.quantity || '',
                'Book Value': p.book_value || '',
                'Market Value': p.market_value || p.value || '',
                'Gain/Loss': p.gain_amount || '',
                Currency: (p.security && p.security.currency) || p.currency || '',
                Institution: p.institution || ''
              };
            });
            
            var ws = XLSX.utils.json_to_sheet(data);
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Positions');
            XLSX.writeFile(wb, 'Wealthica_Positions.xlsx');
            
            log('âœ“ Downloaded Wealthica_Positions.xlsx', 'success');
            status('âœ“ Export complete!');
            document.getElementById('btn-positions').disabled = false;
          }).catch(function(err) {
            log('ERROR: ' + err.message, 'error');
            status('Export failed');
            document.getElementById('btn-positions').disabled = false;
          });
        };
        
        // Export all
        document.getElementById('btn-all').onclick = function() {
          this.disabled = true;
          log('Fetching all data...');
          status('Fetching all data...');
          
          Promise.all([
            addon.api.getTransactions({ 
              from: options.fromDate || '2024-01-01',
              to: options.toDate || new Date().toISOString().split('T')[0]
            }),
            addon.api.getPositions({
              groups: options.groupsFilter,
              institutions: options.institutionsFilter
            })
          ]).then(function(results) {
            var txs = results[0].data || results[0];
            var pos = results[1].data || results[1];
            
            log('âœ“ Fetched ' + txs.length + ' transactions, ' + pos.length + ' positions', 'success');
            
            var txData = txs.map(function(tx) {
              return {
                Date: tx.date || (tx.origin_date ? new Date(tx.origin_date).toISOString().split('T')[0] : ''),
                Type: tx.type || '',
                Description: tx.description || '',
                Symbol: tx.symbol || tx.ticker || '',
                Quantity: tx.quantity || '',
                Price: tx.price || '',
                Amount: tx.currency_amount || tx.amount || '',
                Currency: tx.currency || ''
              };
            });
            
            var posData = pos.map(function(p) {
              return {
                Symbol: (p.security && p.security.symbol) || p.symbol || '',
                Name: (p.security && p.security.name) || p.name || '',
                Quantity: p.quantity || '',
                'Market Value': p.market_value || p.value || '',
                Currency: (p.security && p.security.currency) || p.currency || ''
              };
            });
            
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(txData), 'Transactions');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(posData), 'Positions');
            XLSX.writeFile(wb, 'Wealthica_Complete.xlsx');
            
            log('âœ“ Downloaded Wealthica_Complete.xlsx', 'success');
            status('âœ“ Export complete!');
            document.getElementById('btn-all').disabled = false;
          }).catch(function(err) {
            log('ERROR: ' + err.message, 'error');
            status('Export failed');
            document.getElementById('btn-all').disabled = false;
          });
        };
        
        log('Waiting for Wealthica to connect...');
        status('Waiting for connection...');
      }
      
      // Start checking
      status('Loading libraries...');
      checkLibraries();
    })();
  </script>
</body>
</html>
